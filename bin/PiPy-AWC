#!/usr/bin/env python
import shlex
import sys
import time
from argparse import ArgumentError
from pathlib import Path

from pipyawc import Controller, new_parser, process_remote, process_stardard
from pipyawc.modules.peripherals import CheckError
from pipyawc.modules.services import NotifyType

HOME_DIR = Path(__file__).parents[0]
PROMPT = "Enter command ('end' to exit prompt; 'kill' to terminate process)"


def keyboard_input(controller: Controller):
    inp = input([PROMPT])

    if "end" in inp:
        pass
    elif "kill" in inp:
        print("Terminating program...")
        sys.exit(0)
    else:
        try:
            kb_int_cli = new_parser("remote")
            args = kb_int_cli.parse_args(shlex.split(inp))
            process_remote(args, controller, "print")
        except ArgumentError as e:
            print(f"Error! {e}")
            kb_int_cli.print_help()
            keyboard_input(controller)

    return None


def main(controller: Controller, interval: int = 1):
    last_state: str | CheckError = ""

    while True:
        try:  # Normal loop action
            time.sleep(interval)
            curr_state = controller.monitor.tank_state
            if last_state != curr_state:
                if isinstance(curr_state, CheckError):
                    sensor_values = controller.monitor.sensor_values
                    body = (
                        "Could not get a valid tank state. An invalid sensor "
                        + "configuration was detected."
                        + f"Current sensor values are:\n{sensor_values}"
                    )
                    controller.notify(
                        contacts=[k for k in controller.messenger.contacts.keys()],
                        title="Could not get a valid tank state. An invalid sensor "
                        + "configuration was detected.",
                        body=body,
                        notify_type=NotifyType.WARNING,
                    )
                last_state = controller.monitor.tank_state
                print(f"Tank state is: {last_state}")

            controller.schedule.run_pending()

            if any(controller.pending_commands):
                for msg in controller.pending_commands:
                    email_cli = new_parser("remote")
                    cmd = msg.command
                    args = email_cli.parse_args(cmd)

                    try:
                        process_remote(args, controller, "notify", [msg.sender])
                    except ArgumentError as e:
                        controller.notify(
                            contacts=[msg.sender],
                            body="Type --help for help",
                            title=f"Invalid Command {e}",
                            notify_type=NotifyType.WARNING,
                        )

                    controller.pending_commands.remove(msg)

        except KeyboardInterrupt:  # Process an interupt to the main process
            keyboard_input(controller)


if __name__ == "__main__":
    standard_cli = new_parser("standard")
    args = standard_cli.parse_args()
    controller, interval = process_stardard(args)

    errs = [f"{k}:{v}" for k, v in controller.monitor.error_checks.items()]
    print(errs)
    print(controller.monitor.sensors)
    main(controller, interval)
